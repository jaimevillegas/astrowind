---
import { Image } from 'astro:assets';
import { Icon } from 'astro-icon/components';

// Map of technology names to their corresponding icons
const techIcons = {
  // Web Technologies
  'React': 'logos:react',
  'Next.js': 'logos:nextjs-icon',
  'Astro': 'logos:astro-icon',
  'TailwindCSS': 'logos:tailwindcss-icon',
  'Node.js': 'logos:nodejs-icon',
  'Express': 'simple-icons:express',
  'MongoDB': 'logos:mongodb-icon',
  'Firebase': 'logos:firebase',
  'Supabase': 'logos:supabase-icon',
  'Vercel': 'logos:vercel-icon',
  
  // Engineering Technologies
  'Arduino': 'logos:arduino',
  'Raspberry Pi': 'logos:raspberry-pi',
  'Python': 'logos:python',
  'C++': 'logos:c-plusplus',
  'PCB Design': 'tabler:circuit-board',
  'KiCad': 'simple-icons:kicad',
  'IoT': 'tabler:devices',
  'MQTT': 'tabler:broadcast',
  'SolidWorks': 'tabler:3d-cube-sphere',
  'AutoCAD': 'tabler:ruler',
  'Fusion 360': 'tabler:3d-rotate',
  '3D Printing': 'tabler:printer-3d',
  'CNC Machining': 'tabler:tool',
  'G-code': 'tabler:code',
  'FEA Analysis': 'tabler:chart-dots',
  'Mechanical Design': 'tabler:tools',
  'Sheet Metal': 'tabler:stack-2',
  'Soldering': 'tabler:flame'
};
---

<div id="project-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-900 rounded-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-700">
    <!-- Modal Header -->
    <div class="relative bg-gradient-to-r from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 border-b border-gray-200 dark:border-gray-700 p-6">
      <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full p-2 hover:scale-110">
        <Icon name="tabler:x" class="w-6 h-6" />
      </button>
      <h2 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white pr-16 leading-tight"></h2>
    </div>

    <!-- Modal Content -->
    <div class="overflow-y-auto custom-scrollbar max-h-[calc(95vh-120px)]">
      <!-- New Layout: Image takes more prominence -->
      <div class="flex flex-col">
        <!-- Image Section - Now full width and larger -->
        <div class="relative bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900">
          <div id="modal-image" class="w-full h-[400px] overflow-hidden rounded-b-xl">
            <!-- Image will be inserted here -->
          </div>
          <!-- Decorative overlay -->
          <div class="absolute inset-0 bg-gradient-to-t from-black/10 via-transparent to-transparent"></div>
        </div>

        <!-- Content Section - Below image -->
        <div class="p-6 lg:p-8">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Technologies -->
            <div class="lg:col-span-1">
              <div class="sticky top-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <Icon name="tabler:tools" class="w-5 h-5 text-orange-500" />
                  Tecnologías
                </h3>
                <div id="modal-technologies" class="flex flex-wrap gap-2 mb-6">
                  <!-- Technologies will be inserted here -->
                </div>

                <!-- Action Buttons -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <Icon name="tabler:external-link" class="w-5 h-5 text-orange-500" />
                    Enlaces
                  </h3>
                  <div id="modal-buttons" class="flex flex-col gap-3">
                    <a id="modal-view" target="_blank" class="hidden flex items-center justify-center gap-3 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
                      <Icon name="tabler:eye" class="w-5 h-5" />
                      <span>Ver Proyecto</span>
                    </a>
                    <a id="modal-github" class="hidden flex items-center justify-center gap-3 px-6 py-3 border-2 border-gray-300 dark:border-gray-600 hover:border-orange-500 dark:hover:border-orange-400 text-gray-700 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 bg-gray-50 dark:bg-gray-800 hover:bg-orange-50 dark:hover:bg-gray-700">
                      <Icon name="tabler:brand-github" class="w-5 h-5" />
                      <span>Ver Código</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column: Description -->
            <div class="lg:col-span-2">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <Icon name="tabler:file-text" class="w-5 h-5 text-orange-500" />
                Descripción del Proyecto
              </h3>
              <div class="prose prose-gray dark:prose-invert max-w-none">
                <p id="modal-description" class="text-gray-600 dark:text-gray-300 leading-relaxed text-base"></p>
              </div>

              <!-- Features Section -->
              <div class="mt-6 p-4 bg-gradient-to-r from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 rounded-xl border border-orange-200 dark:border-orange-800/30">
                <div class="flex items-center gap-2 text-orange-700 dark:text-orange-300 mb-3">
                  <Icon name="tabler:bulb" class="w-5 h-5" />
                  <span class="text-sm font-medium">Características destacadas del proyecto</span>
                </div>
                <ul id="modal-features" class="space-y-2">
                  <!-- Features will be inserted here -->
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom scrollbar styles */
  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: theme(colors.orange.500) transparent;
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: theme(colors.orange.500);
    border-radius: 3px;
    transition: background-color 0.2s ease;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: theme(colors.orange.600);
  }

  /* Dark mode scrollbar */
  :global(.dark) .custom-scrollbar {
    scrollbar-color: theme(colors.orange.400) transparent;
  }

  :global(.dark) .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: theme(colors.orange.400);
  }

  :global(.dark) .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: theme(colors.orange.300);
  }

  /* Modal animations */
  #project-modal {
    animation: fadeIn 0.4s ease-out;
  }

  #project-modal > div {
    animation: slideInUp 0.4s ease-out;
  }

  /* Image hover effects */
  #modal-image img {
    transition: transform 0.3s ease-out;
  }

  #modal-image:hover img {
    transform: scale(1.02);
  }

  /* Enhanced button animations */
  #modal-buttons a {
    position: relative;
    overflow: hidden;
  }

  #modal-buttons a::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  #modal-buttons a:hover::before {
    left: 100%;
  }

  /* Smooth section transitions */
  .lg\\:col-span-1, .lg\\:col-span-2 {
    animation: slideInContent 0.6s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes slideInContent {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Custom technology badge animations */
  #modal-technologies span {
    animation: slideInBadge 0.3s ease-out;
    animation-fill-mode: both;
  }

  #modal-technologies span:nth-child(1) { animation-delay: 0.1s; }
  #modal-technologies span:nth-child(2) { animation-delay: 0.15s; }
  #modal-technologies span:nth-child(3) { animation-delay: 0.2s; }
  #modal-technologies span:nth-child(4) { animation-delay: 0.25s; }
  #modal-technologies span:nth-child(5) { animation-delay: 0.3s; }

  @keyframes slideInBadge {
    from {
      opacity: 0;
      transform: translateX(-10px) scale(0.8);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }
</style>

<script define:vars={{ techIcons }}>
  function setupModal() {
    const modal = document.getElementById('project-modal');
    const closeBtn = document.getElementById('close-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalImage = document.getElementById('modal-image');
    const modalDescription = document.getElementById('modal-description');
    const modalView = document.getElementById('modal-view');
    const modalGithub = document.getElementById('modal-github');
    const modalTechnologies = document.getElementById('modal-technologies');
    const modalFeatures = document.getElementById('modal-features');

    // Close modal when clicking the close button
    closeBtn?.addEventListener('click', () => {
      modal?.classList.add('hidden');
    });

    // Close modal when clicking outside
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });

    // Close modal when pressing Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      }
    });

    // Add click event to all project cards
    document.querySelectorAll('.project-card').forEach(card => {
      card.addEventListener('click', () => {
        const project = {
          title: card.dataset.title,
          description: card.dataset.description,
          image: card.dataset.image,
          view: card.dataset.view,
          github: card.dataset.github,
          technologies: JSON.parse(card.dataset.technologies || '[]'),
          features: JSON.parse(card.dataset.features || '[]')
        };

        if (modalTitle) modalTitle.textContent = project.title;
        if (modalDescription) modalDescription.textContent = project.description;
        if (modalView) {
          if (project.view && project.view !== '#') {
            modalView.href = project.view;
            modalView.classList.remove('hidden');
          } else {
            modalView.classList.add('hidden');
          }
        }
        if (modalGithub) {
          if (project.github && project.github !== '#') {
            modalGithub.href = project.github;
            modalGithub.classList.remove('hidden');
          } else {
            modalGithub.classList.add('hidden');
          }
        }
        
        // Create and set the image with better object-fit for full image visibility
        if (modalImage) {
          modalImage.innerHTML = `<img src="${project.image}" alt="${project.title}" class="w-full h-full object-contain bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800">`;
        }

        // Create and set the technologies with icons
        if (modalTechnologies) {
          modalTechnologies.innerHTML = project.technologies
            .map(tech => {
              const iconName = techIcons[tech] || 'tabler:code';
              return `
                <span class="px-3 py-1.5 bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300
                           rounded-full text-sm font-medium flex items-center gap-1.5 group hover:bg-orange-200
                           dark:hover:bg-orange-800 transition-colors">
                  <span class="relative w-4 h-4">
                    <span class="absolute inset-0 flex items-center justify-center">
                      <iconify-icon icon="${iconName}" width="16" height="16"></iconify-icon>
                    </span>
                  </span>
                  ${tech}
                </span>
              `;
            })
            .join('');
        }

        // Create and set the features
        if (modalFeatures) {
          modalFeatures.innerHTML = project.features
            .map(feature => `
              <li class="flex items-start gap-2 text-sm text-orange-700 dark:text-orange-300">
                <span class="flex-shrink-0 w-1.5 h-1.5 rounded-full bg-orange-500 mt-2"></span>
                <span class="leading-relaxed">${feature}</span>
              </li>
            `)
            .join('');
        }

        modal?.classList.remove('hidden');
      });
    });
  }

  // Setup modal when the page loads
  document.addEventListener('astro:page-load', setupModal);
  // Also setup on initial load
  setupModal();
</script>

<!-- Add Iconify script for dynamic icons -->
<script is:inline src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
