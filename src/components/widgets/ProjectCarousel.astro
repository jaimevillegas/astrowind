---
import { Image } from 'astro:assets';
import { Icon } from 'astro-icon/components';

export interface Project {
  title: string;
  description: string;
  image: ImageMetadata;
  view?: string;
  github?: string;
  technologies: string[];
  category: string;
}

export interface Props {
  projects: Project[];
}

const { projects } = Astro.props;

// Detectar idioma de la ruta actual
const currentPath = Astro.url.pathname;
const isSpanish = currentPath.startsWith('/es');

const buttonTexts = {
  viewProject: isSpanish ? 'Ver Proyecto' : 'View Project',
  view: isSpanish ? 'Ver' : 'View'
};

// Map of technology names to their corresponding icons
const techIcons = {
  // Web Technologies - Frontend
  React: 'logos:react',
  'Next.js': 'logos:nextjs-icon',
  Astro: 'logos:astro-icon',
  TailwindCSS: 'logos:tailwindcss-icon',
  TypeScript: 'logos:typescript-icon',
  'Three.js': 'logos:threejs',
  Zustand: 'simple-icons:react',
  'Chart.js': 'logos:chartjs',
  Axios: 'simple-icons:axios',
  // Web Technologies - Backend & CMS
  'Node.js': 'logos:nodejs-icon',
  Express: 'simple-icons:express',
  MongoDB: 'logos:mongodb-icon',
  MySQL: 'logos:mysql',
  PHP: 'logos:php',
  WordPress: 'logos:wordpress-icon',
  Moodle: 'simple-icons:moodle',
  // Cloud & Services
  Firebase: 'logos:firebase',
  Supabase: 'logos:supabase-icon',
  Vercel: 'logos:vercel-icon',
  'Google Sheets API': 'logos:google-drive',
  Recharts: 'tabler:chart-bar',
  // Engineering Technologies - Hardware & Electronics
  Arduino: 'logos:arduino',
  'Raspberry Pi': 'logos:raspberry-pi',
  ESP32: 'simple-icons:espressif',
  ATmega32u4: 'tabler:cpu',
  'PCB Design': 'tabler:settings',
  KiCad: 'simple-icons:kicad',
  KiCAD: 'simple-icons:kicad',
  IoT: 'tabler:cloud',
  MQTT: 'tabler:antenna',
  // Engineering Technologies - CAD & Design
  SolidWorks: 'tabler:box',
  AutoCAD: 'tabler:ruler',
  'CAD Design': 'tabler:box',
  'Fusion 360': 'tabler:rotate',
  '3D Printing': 'tabler:printer',
  'CNC Machining': 'tabler:tool',
  DFM: 'tabler:dimensions',
  // Engineering Technologies - Analysis & Software
  'FEA Analysis': 'tabler:chart-dots',
  'Mechanical Design': 'tabler:tools',
  'Sheet Metal': 'tabler:stack',
  LittleVGL: 'tabler:layout',
  'Squareline Studio': 'tabler:palette',
  'G-code': 'tabler:code',
  // Programming Languages
  Python: 'logos:python',
  'C++': 'logos:c-plusplus',
  // Other
  Soldering: 'tabler:flame',
};
---

<section class="relative not-prose h-[60vh] md:h-[60vh] mx-0 md:mx-4 lg:mx-8 md:rounded-2xl md:border border-gray-200 dark:border-gray-700 md:shadow-lg overflow-hidden">
  <div class="swiper-container project-carousel h-full w-full">
    <div class="swiper-wrapper">
      {
        projects.map((project) => (
          <div class="swiper-slide">
            <div class="h-full w-full relative">
              <!-- Background image covering full height -->
              <div class="absolute inset-0">
                <Image
                  src={project.image}
                  alt={project.title}
                  class="w-full h-full object-cover"
                  widths={[400, 768, 1024, 2048]}
                  sizes="(max-width: 768px) 100vw, 50vw"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/60 to-black/30 md:bg-gradient-to-r md:from-black/90 md:via-black/50 md:to-transparent"></div>
              </div>

              <!-- Content overlay - mobile optimized -->
              <div class="relative h-full flex flex-col justify-end md:justify-center p-4 pb-8 sm:p-4 md:p-8 lg:p-12 text-white md:w-11/12 lg:w-5/6">
                <p class="text-orange-400 uppercase tracking-wider font-medium text-xs sm:text-sm mb-1 sm:mb-2">{project.category}</p>
                <h2 class="text-4xl font-bold leading-tight mb-2 sm:mb-3 md:mb-4">{project.title}</h2>
                <div class="max-h-28 sm:max-h-36 md:max-h-48 overflow-y-auto mb-2 sm:mb-3 md:mb-4 custom-scrollbar-carousel">
                  <p class="text-lg text-gray-200 leading-relaxed" style="font-size: 18px;">{project.description}</p>
                </div>
                <div class="flex flex-wrap gap-2 mb-3 sm:mb-4 md:mb-6">
                  {project.technologies.slice(0, 4).map((tech) => {
                    // Get icon name with fallback to generic code icon
                    const iconName = techIcons[tech] || 'tabler:code';

                    return (
                      <span class="inline-flex items-center gap-1.5 sm:gap-2 px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs font-semibold text-orange-700 bg-orange-100 rounded-full dark:bg-orange-900/50 dark:text-orange-300 border border-orange-200 dark:border-orange-800 hover:bg-orange-200 dark:hover:bg-orange-900 transition-colors duration-200">
                        <Icon name={iconName} class="w-3 h-3 sm:w-3.5 sm:h-3.5 flex-shrink-0" />
                        {tech}
                      </span>
                    );
                  })}
                </div>
                <div class="flex gap-3 sm:gap-4">
                  {project.view && project.view !== '#' && (
                    <a
                      href={project.view}
                      target="_blank"
                      class="flex items-center gap-1.5 sm:gap-2 px-4 sm:px-6 py-2 sm:py-3 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm sm:text-base font-semibold transition-colors duration-300"
                    >
                      <Icon name="tabler:external-link" class="w-4 h-4 sm:w-5 sm:h-5" />
                      <span class="hidden xs:inline">{buttonTexts.viewProject}</span>
                      <span class="xs:hidden">{buttonTexts.view}</span>
                    </a>
                  )}
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>
    <!-- Navigation arrows - hidden on mobile -->
    <div class="swiper-button-prev project-carousel-prev hidden md:flex !text-orange-500 after:!text-2xl"></div>
    <div class="swiper-button-next project-carousel-next hidden md:flex !text-orange-500 after:!text-2xl"></div>
  </div>
</section>

<!-- Load Swiper from CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script is:inline src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script is:inline>
  // Retry counter to prevent infinite loops
  window.projectCarouselRetryCount = 0;
  window.maxProjectCarouselRetries = 10;

  // Define the function globally so it persists across navigations
  window.initProjectCarousel = function(resetRetryCount = false) {
    // Quick check: only continue if we're on a projects page
    const isProjectsPage = window.location.pathname.includes('/projects');

    if (!isProjectsPage) {
      // Silently skip initialization if not on projects page
      return;
    }

    if (resetRetryCount) {
      window.projectCarouselRetryCount = 0;
    }


    const element = document.querySelector('.project-carousel');

    if (!element) {
      // Retry logic for projects page only
      if (window.projectCarouselRetryCount < window.maxProjectCarouselRetries) {
        window.projectCarouselRetryCount++;
        setTimeout(function() { window.initProjectCarousel(false); }, 100);
      } else {
        window.projectCarouselRetryCount = 0; // Reset for next navigation
      }
      return;
    }

    if (typeof Swiper === 'undefined') {
      return;
    }

    // Reset retry counter on success
    window.projectCarouselRetryCount = 0;

    // Destroy existing Swiper instance if it exists
    if (element.swiper) {
      element.swiper.destroy(true, true);
    }

    try {
      const projectCarousel = new Swiper('.project-carousel', {
        loop: true,
        effect: 'fade',
        fadeEffect: {
          crossFade: true
        },
        autoplay: {
          delay: 7000,
          disableOnInteraction: false,
          pauseOnMouseEnter: true,
        },
        navigation: {
          nextEl: '.project-carousel-next',
          prevEl: '.project-carousel-prev',
        },
        touchRatio: 1,
        touchAngle: 45,
        grabCursor: true,
        resistance: true,
        resistanceRatio: 0.85,
        speed: 600,
      });

    } catch (error) {
    }
  };

  // Register event listeners only once
  if (!window.projectCarouselListenersRegistered) {

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', window.initProjectCarousel);
    } else {
      window.initProjectCarousel();
    }

    // Listen for Astro View Transitions after swap (content replaced but not yet visible)
    document.addEventListener('astro:after-swap', function() {
      // Reset retry count for new navigation
      setTimeout(function() { window.initProjectCarousel(true); }, 50);
    });

    // Listen for Astro View Transitions page load event (after animations complete)
    document.addEventListener('astro:page-load', function() {
      window.initProjectCarousel(true);
    });

    // Fallback for window load
    window.addEventListener('load', function() {
      const element = document.querySelector('.project-carousel');
      if (element && !element.swiper) {
        window.initProjectCarousel();
      }
    });

    window.projectCarouselListenersRegistered = true;
  } else {
    window.initProjectCarousel();
  }
</script>

<style>
  /* Navigation arrows - desktop only */
  .project-carousel .swiper-button-prev,
  .project-carousel .swiper-button-next {
    transition: all 0.3s ease;
    transform: translateY(-50%);
    opacity: 0.7;
  }
  .project-carousel .swiper-button-prev {
    left: 20px;
  }
  .project-carousel .swiper-button-next {
    right: 20px;
  }
  .project-carousel:hover .swiper-button-prev,
  .project-carousel:hover .swiper-button-next {
    opacity: 1;
  }
  .project-carousel .swiper-button-prev:hover,
  .project-carousel .swiper-button-next:hover {
    transform: translateY(-50%) scale(1.2);
    color: #fb923c; /* orange-400 */
  }

  /* Pagination styling */
  .project-carousel .swiper-pagination {
    bottom: 12px !important;
  }

  .project-carousel .swiper-pagination-bullet {
    width: 8px;
    height: 8px;
    background-color: rgba(255, 255, 255, 0.6);
    opacity: 1;
    transition: all 0.3s ease;
    margin: 0 4px !important;
  }

  .project-carousel .swiper-pagination-bullet-active {
    width: 24px;
    border-radius: 4px;
    background-color: #ea580c; /* orange-600 */
  }

  /* Custom scrollbar for description */
  .custom-scrollbar-carousel {
    scrollbar-width: thin;
    scrollbar-color: rgba(249, 115, 22, 0.5) transparent;
  }

  .custom-scrollbar-carousel::-webkit-scrollbar {
    width: 4px;
  }

  .custom-scrollbar-carousel::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar-carousel::-webkit-scrollbar-thumb {
    background-color: rgba(249, 115, 22, 0.5);
    border-radius: 2px;
    transition: background-color 0.2s ease;
  }

  .custom-scrollbar-carousel::-webkit-scrollbar-thumb:hover {
    background-color: rgba(249, 115, 22, 0.8);
  }

  /* Mobile optimization */
  @media (max-width: 640px) {
    .project-carousel .swiper-pagination {
      bottom: 8px !important;
    }

    .project-carousel .swiper-pagination-bullet {
      width: 6px;
      height: 6px;
      margin: 0 3px !important;
    }

    .project-carousel .swiper-pagination-bullet-active {
      width: 20px;
    }
  }

  /* Tablet optimization */
  @media (min-width: 768px) {
    .project-carousel .swiper-pagination {
      bottom: 16px !important;
    }

    .project-carousel .swiper-pagination-bullet {
      width: 10px;
      height: 10px;
      margin: 0 5px !important;
    }

    .project-carousel .swiper-pagination-bullet-active {
      width: 28px;
    }
  }

  /* Ensure swiper slide takes full height */
  .project-carousel .swiper-slide {
    height: auto;
  }
</style>
